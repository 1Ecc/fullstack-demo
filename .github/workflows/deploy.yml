name: è‡ªåŠ¨éƒ¨ç½²åç«¯é¡¹ç›®åˆ°é˜¿é‡Œäº‘

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸš€ ç¬¬äºŒæ­¥ï¼šSCP ä¼ è¾“æ–‡ä»¶
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          source: "*"
          target: "/opt/app/server" # æ³¨æ„è¿™é‡Œè·¯å¾„æ”¹æˆäº† server
          strip_components: 0

      - name: ğŸ› ï¸ ç¬¬ä¸‰æ­¥ï¼šè¿œç¨‹æ‰§è¡Œé‡å¯å‘½ä»¤
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          script: |
            cd /opt/app
            # 1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…å¯èƒ½çš„ä¾èµ–
            source venv/bin/activate
            pip install -r /opt/app/server/requirements.txt
            # 2. é‡å¯æœåŠ¡å™¨ä¸Šçš„ nodeapp æœåŠ¡ï¼ˆè¿™å°±æ˜¯æˆ‘ä»¬åœ¨æ–¹æ¡ˆAé‡Œé…ç½®çš„é‚£ä¸ªï¼‰
            systemctl restart nodeapp